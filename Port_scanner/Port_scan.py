# Python Port scan from violent python book

import argparse
import socket
import threading # allows port scanning to be done simultaneously.

def port_scan(tgt_host, tgt_ports):
	try:
		tgt_ip = socket.gethostbyname(tgt_host)	# uses the socket plugin to get ip address from a hostname.
	except socket.herror:
		print(f'[-] Cannot resolve {tgt_host}: Unknown host')
		return

	try:
		tgt_name = socket.gethostbyaddr(tgt_ip)
		print(f'\n[+] Scan Results for: {tgt_name[0]}')
	except socket.herror:
		print(f'\n[+] Scan Result for: {tgt_ip}')

	socket.setdefaulttimeout(1)
		
	for ports in tgt_ports: # for loop that threads each port.
		t = threading.Thread(target=conn_scan, args=(tgt_host, int(ports)))
		t.start() # thread the ports as declared above.


def conn_scan(tgt_host, tgt_port): #determines if the port is open or closed.
	screen_lock = threading.Semaphore()
	with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as conn_skt:
		try:
			conn_skt.connect((tgt_host, tgt_port))
			conn_skt.send(b'ViolentPython\r\n') # sends packets to the port to get an ACK responce, which tells whether the port is open or closed.
			results = conn_skt.recv(100).decode('utf-8')
			screen_lock.acquire()
			print(f'[+] {tgt_port}/tcp open') # port is open.
			print(f'	[>] {results}')
		except OSError:
			screen_lock.acquire()
			print(f'[-] {tgt_port}/tcp closed') # port is closed.
		finally:
			screen_lock.release()


if __name__ == '__main__': # main part of the program.
	parser = argparse.ArgumentParser( # tells user how to use it.
		usage ='Port_scan.py TARGET_HOST -p TARGET_PORTS'
			'\nexample: python3 Port_scan.py scanme.nmap.org -p 21,80')
	
	parser.add_argument('tgt_host', type=str, metavar='TARGET_HOST', help='specify target host (IP address or domain name)')
	parser.add_argument('-p', required=True, type=str, metavar='TARGET_PORTS', help='specify target port[s] separated by comma (no spaces)')
	args = parser.parse_args()

	args.tgt_ports = str(args.p).split(',') # dictates that target ports need to be separated by a comma.
	port_scan(args.tgt_host, args.tgt_ports) # calls the port_scan function above.

# To test I used scanme.nmap.org with a variety of ports. I found that, of the ports tested, 22 and 80 were open.
